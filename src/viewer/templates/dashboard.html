{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Header & Controls -->
<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-100">Applicants</h2>
        <p class="text-sm text-gray-500 mt-1">{{ total }} candidate{{ 's' if total != 1 }} Â· Visiting Assistant Professor (Teaching Focus, 2-year)</p>
    </div>

    <!-- Filters -->
    <form method="GET" action="/" class="flex flex-wrap items-center gap-3 text-sm">
        <label class="text-gray-400">Sort:</label>
        <select name="sort" onchange="this.form.submit()"
                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-200 text-sm">
            <option value="teaching" {{ 'selected' if sort_by == 'teaching' }}>Teaching â­</option>
            <option value="research" {{ 'selected' if sort_by == 'research' }}>Research â­</option>
            <option value="fit" {{ 'selected' if sort_by == 'fit' }}>Fit Score</option>
            <option value="rank" {{ 'selected' if sort_by == 'rank' }}>Comparative Rank</option>
            <option value="name" {{ 'selected' if sort_by == 'name' }}>Name</option>
        </select>

        <label class="text-gray-400">Rec:</label>
        <select name="rec" onchange="this.form.submit()"
                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-200 text-sm">
            <option value="all" {{ 'selected' if filter_rec == 'all' }}>All</option>
            <option value="Strong" {{ 'selected' if filter_rec == 'Strong' }}>ğŸŸ¢ Strong</option>
            <option value="Moderate" {{ 'selected' if filter_rec == 'Moderate' }}>ğŸŸ¡ Moderate</option>
            <option value="Weak" {{ 'selected' if filter_rec == 'Weak' }}>ğŸŸ  Weak</option>
            <option value="Do Not Advance" {{ 'selected' if filter_rec == 'Do Not Advance' }}>ğŸ”´ Do Not Advance</option>
        </select>

        <label class="text-gray-400">Min Teaching:</label>
        <select name="min_teaching" onchange="this.form.submit()"
                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-200 text-sm">
            <option value="0" {{ 'selected' if min_teaching == 0 }}>Any</option>
            <option value="3" {{ 'selected' if min_teaching == 3 }}>â­â­â­+</option>
            <option value="4" {{ 'selected' if min_teaching == 4 }}>â­â­â­â­+</option>
            <option value="5" {{ 'selected' if min_teaching == 5 }}>â­â­â­â­â­</option>
        </select>

        <label class="text-gray-400">Show:</label>
        <select name="show" onchange="this.form.submit()"
                class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-200 text-sm">
            <option value="all" {{ 'selected' if filter_show == 'all' }}>All</option>
            <option value="shortlisted" {{ 'selected' if filter_show == 'shortlisted' }}>â˜… Shortlisted</option>
            <option value="reviewed" {{ 'selected' if filter_show == 'reviewed' }}>âœ“ Reviewed</option>
            <option value="unreviewed" {{ 'selected' if filter_show == 'unreviewed' }}>Unreviewed</option>
        </select>

        <!-- Live search -->
        <input type="text" id="search-box" placeholder="Search names..."
               class="bg-gray-800 border border-gray-700 rounded px-3 py-1 text-gray-200 text-sm w-40 focus:outline-none focus:border-purdue-gold">
    </form>
</div>

{% if applicants %}
<!-- Applicant Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="applicant-grid">
    {% for a in applicants %}
    {% set p = a.profile %}
    {% set e = a.evaluation %}
    {% set rv = a.get('review', {}) %}
    {% set pm = a.get('processing_meta', {}) %}
    <a href="/applicant/{{ a.folder_name }}"
       class="card-hover block bg-gray-900 border {{ 'border-purdue-gold/40' if rv.get('shortlist') else 'border-gray-800' }} rounded-lg p-5 applicant-card"
       data-name="{{ p.name|lower }}">

        <!-- Header row -->
        <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                    <h3 class="font-semibold text-gray-100 truncate">{{ p.name }}</h3>
                    {% if rv.get('shortlist') %}
                    <span class="text-purdue-gold text-xs">â˜…</span>
                    {% endif %}
                    {% if rv.get('reviewed') %}
                    <span class="text-xs text-purdue-gold/60">âœ“</span>
                    {% endif %}
                </div>
                <p class="text-xs text-gray-500 truncate mt-0.5">
                    {{ p.terminal_degree or 'Degree not specified' }}
                    {% if p.degree_status and p.degree_status != 'Completed' %}
                        <span class="text-yellow-500">({{ p.degree_status }})</span>
                    {% endif %}
                </p>
                <p class="text-xs text-gray-600 truncate">{{ p.degree_institution }}</p>
            </div>
            <span class="text-xl ml-2" title="{{ e.overall_recommendation }}">
                {{ e.overall_recommendation|rec_emoji }}
            </span>
        </div>

        <!-- Ratings -->
        <div class="flex items-center gap-4 text-xs mb-3">
            <div>
                <span class="text-gray-500">Teaching:</span>
                <span class="stars">{{ e.teaching_stars|stars }}</span>
                {% if e.get('_overrides', {}).get('teaching_stars') %}
                <span class="text-purdue-gold/50 text-xs" title="Human override">âœ</span>
                {% endif %}
            </div>
            <div>
                <span class="text-gray-500">Research:</span>
                <span class="stars">{{ e.research_stars|stars }}</span>
                {% if e.get('_overrides', {}).get('research_stars') %}
                <span class="text-purdue-gold/50 text-xs" title="Human override">âœ</span>
                {% endif %}
            </div>
        </div>

        <!-- Comparative scores (if available) -->
        {% set comp = a.get('comparative', {}) %}
        {% if comp.get('tier') %}
        <div class="flex items-center gap-3 text-xs mb-3 p-2 bg-gray-800/50 rounded">
            <span class="font-medium {{ {'Top':'text-green-400','Strong':'text-blue-400','Middle':'text-yellow-400','Below Average':'text-orange-400','Weak':'text-red-400'}.get(comp.tier, 'text-gray-400') }}">
                {{ {'Top':'ğŸ†','Strong':'ğŸŸ¢','Middle':'ğŸŸ¡','Below Average':'ğŸŸ ','Weak':'ğŸ”´'}.get(comp.tier, 'âšª') }} {{ comp.tier }}
            </span>
            <span class="text-gray-500">
                Curved: T:{{ comp.teaching_curved }}â­ R:{{ comp.research_curved }}â­
            </span>
            <span class="text-gray-600">#{{ comp.teaching_rank }}</span>
        </div>
        {% endif %}

        <!-- Quick stats -->
        <div class="flex flex-wrap gap-2 text-xs mb-3">
            {% if p.is_statistics_adjacent %}
            <span class="bg-green-900/30 text-green-400 px-2 py-0.5 rounded">Stats-Adjacent âœ“</span>
            {% else %}
            <span class="bg-red-900/30 text-red-400 px-2 py-0.5 rounded">Non-Adjacent</span>
            {% endif %}

            {% if p.ai_in_education %}
            <span class="bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded">AI in Ed âœ“</span>
            {% endif %}

            {% set instructor_count = p.courses_taught|selectattr('role', 'in', ['instructor', 'co-instructor'])|list|length %}
            {% if instructor_count > 0 %}
            <span class="bg-purple-900/30 text-purple-400 px-2 py-0.5 rounded">{{ instructor_count }} courses taught</span>
            {% endif %}

            {# RAG / Ensemble badges #}
            {% if pm.get('rag_enabled') %}
            <span class="bg-cyan-900/30 text-cyan-400 px-2 py-0.5 rounded" title="Evaluated with RAG knowledge base">ğŸ“š RAG</span>
            {% endif %}
            {% if pm.get('ensemble_enabled') %}
            <span class="bg-violet-900/30 text-violet-400 px-2 py-0.5 rounded" title="Evaluated with {{ pm.get('ensemble_models', [])|length }}-model ensemble">ğŸ¤– Ensemble</span>
            {% endif %}
        </div>

        <!-- Red flags -->
        {% if e.red_flags %}
        <div class="text-xs text-orange-400 mb-2">
            âš ï¸ {{ e.red_flags|length }} red flag{{ 's' if e.red_flags|length != 1 }}
        </div>
        {% endif %}

        <!-- Comment preview -->
        {% if rv.get('comments') %}
        <div class="text-xs text-gray-500 mb-2 truncate italic">
            ğŸ’¬ {{ rv.comments[:80] }}{{ '...' if rv.comments|length > 80 }}
        </div>
        {% endif %}

        <!-- Recommendation -->
        <div class="mt-auto">
            <span class="text-xs font-medium {{ e.overall_recommendation|rec_color }}">
                {{ e.overall_recommendation }}
            </span>
        </div>
    </a>
    {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="text-center py-20">
    <p class="text-gray-500 text-lg">No applicants found</p>
    <p class="text-gray-600 text-sm mt-2">
        Run <code class="bg-gray-800 px-2 py-1 rounded text-purdue-gold">python run.py process &lt;applicants_dir&gt;</code> first
    </p>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
    // Live search filtering
    const searchBox = document.getElementById('search-box');
    const cards = document.querySelectorAll('.applicant-card');

    if (searchBox) {
        searchBox.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            cards.forEach(card => {
                const name = card.dataset.name || '';
                card.style.display = name.includes(query) ? '' : 'none';
            });
        });
    }
</script>
{% endblock %}